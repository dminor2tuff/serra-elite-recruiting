<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Recruit Profile | Serra Elite Recruiting</title>
  <link rel="stylesheet" href="styles.css?v=41" />
</head>
<body><script src="auth.js"></script>
<script>
  Auth.requireCoach();
</script>

<header class="site-header">
  <div class="header-inner">
    <a class="brand" href="index.html">
      <img src="images/serra_logo.png" class="logo" alt="Serra Football" onerror="this.style.display='none'">
      <span>Serra Elite Recruiting</span>
    </a>

    <nav class="nav-links">
      <a href="index.html">Home</a>
      <a href="recruits.html" class="active">Recruits</a>
      <a class="pill-link coach" href="coach-login.html?next=recruits.html">Coach Login</a>
      <a class="pill-link admin" href="admin-login.html?next=admin.html">Admin Login</a>
    </nav>

    <button class="menu-toggle" type="button" onclick="toggleMenu()">☰</button>
  </div>

  <div id="mobileMenu" class="mobile-menu">
    <a href="index.html">Home</a>
    <a href="recruits.html" class="active">Recruits</a>
    <a href="coach-login.html?next=recruits.html">Coach Login</a>
    <a href="admin-login.html?next=admin.html">Admin Login</a>
  </div>
</header>

<main class="container" style="padding-top:18px;">
  <div id="profile" class="profile-card">
    <div class="status">Loading profile…</div>
  </div>
</main>

<script src="auth.js?v=41"></script>

<script>
/* ===============================
   CONFIG
================================ */
const CSV_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vRZdfePIY8K8ag6AePllWRgYXhjJ-gJddB_8rDaJi3t5BAT11bHVK6m5cDsDQXg2PUIYPqHYcXyxbT2/pub?output=csv";

/* ===============================
   AUTH
================================ */
if (window.Auth) {
  Auth.requireCoach();
}

/* ===============================
   HELPERS
================================ */
function toggleMenu() {
  const m = document.getElementById("mobileMenu");
  m.style.display = (m.style.display === "flex") ? "none" : "flex";
}

function normalizeKey(s) {
  return String(s || "").trim().toLowerCase().replace(/\s+/g, "");
}

function slugify(s) {
  return String(s || "")
    .trim()
    .toLowerCase()
    .replace(/&/g, "and")
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/(^-|-$)/g, "");
}

function normalizeImage(v) {
  if (!v) return "images/placeholder.png";
  v = v.trim();
  if (v.startsWith("http")) return v;
  if (v.startsWith("images/")) return v;
  return `images/${v}`;
}

function normalizeTwitter(v) {
  if (!v) return "";
  v = v.trim();
  if (!v) return "";
  if (v.startsWith("http")) return v;
  v = v.replace("@", "");
  return `https://twitter.com/${v}`;
}

function normalizeHudl(v) {
  if (!v) return "";
  v = v.trim();
  return v.startsWith("http") ? v : "";
}

/* ===============================
   CSV PARSER (ROBUST)
================================ */
function parseCSV(text) {
  const rows = [];
  let row = [];
  let cur = "";
  let inQuotes = false;

  for (let i = 0; i < text.length; i++) {
    const c = text[i];
    const n = text[i + 1];

    if (c === '"' && inQuotes && n === '"') {
      cur += '"';
      i++;
    } else if (c === '"') {
      inQuotes = !inQuotes;
    } else if (c === "," && !inQuotes) {
      row.push(cur);
      cur = "";
    } else if ((c === "\n" || c === "\r") && !inQuotes) {
      if (cur.length || row.length) row.push(cur);
      if (row.length) rows.push(row);
      row = [];
      cur = "";
      if (c === "\r" && n === "\n") i++;
    } else {
      cur += c;
    }
  }
  if (cur.length || row.length) {
    row.push(cur);
    rows.push(row);
  }
  return rows;
}

/* ===============================
   LOAD PROFILE
================================ */
async function loadProfile() {
  const id = new URLSearchParams(location.search).get("id");
  const box = document.getElementById("profile");

  if (!id) {
    box.innerHTML = `<div class="status">No profile selected.</div>`;
    return;
  }

  const res = await fetch(CSV_URL, { cache: "no-store" });
  const text = await res.text();
  const rows = parseCSV(text);

  const headers = rows[0];
  const map = {};
  headers.forEach((h, i) => map[normalizeKey(h)] = i);

  const data = rows.slice(1).map(r => {
    const name = r[map.name] || "";
    if (!name) return null;

    return {
      name: name.trim(),
      slug: slugify(name),
      classYear: (r[map.class] || "").trim(),
      position: (r[map.position] || "").trim(),
      heightWeight: (r[map.heightweight] || "").trim(),
      gpa: (r[map.gpa] || "").trim(),
      writeup: (r[map.writeup] || "").trim(),
      photo: normalizeImage(r[map.imageurl] || ""),
      twitter: normalizeTwitter(r[map.twitter] || ""),
      hudl: normalizeHudl(r[map.hudl] || "")
    };
  }).filter(Boolean);

  const p = data.find(x => x.slug === id);

  if (!p) {
    box.innerHTML = `<div class="status">Profile not found.</div>`;
    return;
  }

  document.title = `${p.name} | Serra Elite Recruiting`;

  box.innerHTML = `
    <div class="profile-top">
      <div class="profile-photo">
        <img src="${p.photo}" alt="${p.name}"
             onerror="this.src='images/placeholder.png'">
      </div>

      <div class="profile-info">
        <h1 class="profile-name">${p.name}</h1>
        <div class="muted">${p.position}</div>
        <div class="muted">Class of ${p.classYear}${p.gpa ? ` • GPA ${p.gpa}` : ""}</div>
        <div class="muted">${p.heightWeight}</div>

        <div class="profile-links">
          ${p.twitter ? `
            <a class="btn small" href="${p.twitter}" target="_blank" rel="noopener">
              X / Twitter
            </a>` : ""}

          ${p.hudl ? `
            <a class="btn small" href="${p.hudl}" target="_blank" rel="noopener">
              Hudl Film
            </a>` : ""}

          <a class="btn small" href="recruits.html">Back to Recruits</a>
        </div>
      </div>
    </div>

    ${p.writeup ? `
      <div class="writeup">
        <h3>Scouting Write-Up</h3>
        <p>${p.writeup.replace(/\n/g, "<br>")}</p>
      </div>` : ""}
  `;
}

loadProfile().catch(() => {
  document.getElementById("profile").innerHTML =
    `<div class="status">Error loading profile.</div>`;
});
</script>

</body>
</html>