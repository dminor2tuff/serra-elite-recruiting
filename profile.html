<!doctype html>
<html lang="en">
<head>
  <base href="/serra-elite-recruiting/">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Player Profile • Serra Elite Recruiting</title>
  <link rel="stylesheet" href="styles.css?v=25">
</head>
<body>

<header class="site-header">
  <div class="header-inner">
    <div class="brand">
      <img class="logo" src="images/serra_logo.png" alt="Serra Football">
      <span>Serra Elite Recruiting</span>
    </div>
    <nav class="nav-links">
      <a href="index.html">Home</a>
      <a class="primary" href="recruits.html">Recruits</a>
      <a href="#" id="logoutLink">Logout</a>
    </nav>
  </div>
</header>

<div class="container">
  <a class="btn" href="recruits.html">← Back to Recruits</a>

  <div id="wrap" class="profile" style="display:none;">
    <div class="panel">
      <div class="big-photo"><img id="photo" src="images/placeholder.png" alt=""></div>
      <div class="pad">
        <h2 id="name" style="margin:0 0 6px;"></h2>
        <div class="small-muted" id="line"></div>

        <div class="btn-row" style="margin-top:12px">
          <a class="btn" id="hudlBtn" target="_blank" rel="noopener" style="display:none;">Hudl</a>
          <a class="btn" id="twBtn" target="_blank" rel="noopener" style="display:none;">Twitter</a>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="pad">
        <h2 style="margin:0 0 10px;">Snapshot</h2>
        <div class="kv">
          <div class="box"><div class="label">Position</div><div class="val" id="pos"></div></div>
          <div class="box"><div class="label">Class</div><div class="val" id="cls"></div></div>
          <div class="box"><div class="label">Height</div><div class="val" id="ht"></div></div>
          <div class="box"><div class="label">Weight</div><div class="val" id="wt"></div></div>
          <div class="box"><div class="label">GPA</div><div class="val" id="gpa"></div></div>
          <div class="box"><div class="label">Profile ID</div><div class="val" id="pid"></div></div>
        </div>

        <div class="section" style="margin-top:14px;">
          <h2>Coach Notes</h2>
          <p>For verified recruiting access and transcripts, contact Serra Football Recruiting staff.</p>
        </div>
      </div>
    </div>
  </div>

  <div id="status" class="small-muted" style="margin-top:14px;">Loading profile…</div>
</div>

<script src="auth.js?v=25"></script>
<script>
  SerraAuth.requireCoach({ next: "profile.html" });
  document.getElementById("logoutLink").addEventListener("click", (e)=>{ e.preventDefault(); SerraAuth.coachLogout(); });

  const CSV_URL =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vRZdfePIY8K8ag6AePllWRgYXhjJ-gJddB_8rDaJi3t5BAT11bHVK6m5cDsDQXg2PUIYPqHYcXyxbT2/pub?output=csv";

  function slugify(s){
    return (s || "").toLowerCase().trim().replace(/['"]/g,"").replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"");
  }
  function parseCSV(text){
    const rows=[]; let cur=[]; let val=""; let inQ=false;
    for(let i=0;i<text.length;i++){
      const c=text[i], n=text[i+1];
      if(c === '"' && inQ && n === '"'){ val+='"'; i++; continue; }
      if(c === '"'){ inQ=!inQ; continue; }
      if(c === "," && !inQ){ cur.push(val); val=""; continue; }
      if((c === "\n" || c === "\r") && !inQ){
        if(c === "\r" && n === "\n") i++;
        cur.push(val); rows.push(cur); cur=[]; val=""; continue;
      }
      val += c;
    }
    if(val.length || cur.length){ cur.push(val); rows.push(cur); }
    return rows;
  }
  function getHeaderIndex(headers, aliases){
    const lower=headers.map(h=>(h||"").toLowerCase().trim());
    for(const a of aliases){ const i=lower.indexOf(a); if(i!==-1) return i; }
    return -1;
  }
  function resolvePhotoUrl(v){
    v = (v||"").trim();
    if(!v) return "images/placeholder.png";
    if(/^https?:\/\//i.test(v)) return v;
    if(v.includes("raw.githubusercontent.com")) return v.startsWith("http") ? v : `https://${v}`;
    return `images/${v}`;
  }
  function toTwitterUrl(v){
    v=(v||"").trim();
    if(!v) return "";
    if(v.startsWith("@")) v=v.slice(1);
    if(v.startsWith("http")) return v;
    v=v.replace("x.com/","").replace("twitter.com/","");
    return `https://twitter.com/${v}`;
  }
  function toHudlUrl(v){
    v=(v||"").trim();
    if(!v) return "";
    if(v.startsWith("http")) return v;
    return `https://www.hudl.com/profile/${v}`;
  }

  const id = new URLSearchParams(location.search).get("id") || "";
  const statusEl = document.getElementById("status");

  async function load(){
    try{
      const res = await fetch(`${CSV_URL}&t=${Date.now()}`, { cache:"no-store" });
      const text = await res.text();
      const table = parseCSV(text);
      const headers = table.shift() || [];

      const idx = {
        name: getHeaderIndex(headers, ["name","player","full name","athlete"]),
        pos: getHeaderIndex(headers, ["position","pos"]),
        cls: getHeaderIndex(headers, ["class","class year","grad year","year"]),
        ht: getHeaderIndex(headers, ["height","ht"]),
        wt: getHeaderIndex(headers, ["weight","wt"]),
        gpa: getHeaderIndex(headers, ["gpa"]),
        hudl: getHeaderIndex(headers, ["hudl","hudl link","hudl url"]),
        twitter: getHeaderIndex(headers, ["twitter","x","twitter link","x link","twitter url"]),
        photo: getHeaderIndex(headers, ["photo","photo url","image","image url","pic","picture","headshot","photo_filename","photo filename","photo file"])
      };

      const players = table
        .filter(r => r.some(cell => String(cell||"").trim() !== ""))
        .map(r => {
          const name = r[idx.name] || "";
          const pid = slugify(name);
          return {
            id: pid,
            name,
            pos: r[idx.pos] || "",
            cls: r[idx.cls] || "",
            ht: r[idx.ht] || "",
            wt: r[idx.wt] || "",
            gpa: idx.gpa>=0 ? (r[idx.gpa]||"") : "",
            hudl: idx.hudl>=0 ? toHudlUrl(r[idx.hudl]) : "",
            twitter: idx.twitter>=0 ? toTwitterUrl(r[idx.twitter]) : "",
            photo: idx.photo>=0 ? resolvePhotoUrl(r[idx.photo]) : "images/placeholder.png"
          };
        });

      const p = players.find(x => x.id === id);
      if(!p){
        statusEl.textContent = "Profile not found. Go back to recruits and try again.";
        return;
      }

      document.getElementById("wrap").style.display = "";
      statusEl.style.display = "none";

      document.getElementById("photo").src = p.photo;
      document.getElementById("photo").alt = p.name;
      document.getElementById("name").textContent = p.name;
      document.getElementById("line").textContent = `${p.pos || "-"} • Class of ${p.cls || "-"} • ${p.ht || "-"} / ${p.wt || "-"}`;
      document.getElementById("pos").textContent = p.pos || "-";
      document.getElementById("cls").textContent = p.cls || "-";
      document.getElementById("ht").textContent = p.ht || "-";
      document.getElementById("wt").textContent = p.wt || "-";
      document.getElementById("gpa").textContent = p.gpa || "-";
      document.getElementById("pid").textContent = p.id || "-";

      const hudlBtn = document.getElementById("hudlBtn");
      if(p.hudl){ hudlBtn.href = p.hudl; hudlBtn.style.display="inline-flex"; }

      const twBtn = document.getElementById("twBtn");
      if(p.twitter){ twBtn.href = p.twitter; twBtn.style.display="inline-flex"; }

    }catch(e){
      console.error(e);
      statusEl.textContent = "Could not load profile from Google Sheets.";
    }
  }
  load();
</script>
</body>
</html>