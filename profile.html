<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Recruit Profile</title>
  <link rel="stylesheet" href="styles.css?v=40" />
</head>
<body>

<header class="site-header">
  <div class="header-inner">
    <a class="brand" href="index.html">
      <img src="images/serra_logo.png" class="logo" alt="Serra" onerror="this.style.display='none'">
      <span>Serra Elite Recruiting</span>
    </a>
    <nav class="nav-links">
      <a href="index.html">Home</a>
      <a href="recruits.html" class="active">Recruits</a>
      <a class="pill-link coach" href="coach-login.html?next=recruits.html">Coach Login</a>
      <a class="pill-link admin" href="admin-login.html?next=admin.html">Admin Login</a>
    </nav>
    <button class="menu-toggle" type="button" onclick="toggleMenu()" aria-label="Open menu">☰</button>
  </div>
  <div id="mobileMenu" class="mobile-menu">
    <a href="index.html">Home</a>
    <a href="recruits.html" class="active">Recruits</a>
    <a href="coach-login.html?next=recruits.html">Coach Login</a>
    <a href="admin-login.html?next=admin.html">Admin Login</a>
  </div>
</header>

<main class="container" style="padding-top:18px;">
  <div id="profile" class="profile-card">
    <div class="status">Loading profile…</div>
  </div>
</main>

<script src="auth.js?v=40"></script>
<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRZdfePIY8K8ag6AePllWRgYXhjJ-gJddB_8rDaJi3t5BAT11bHVK6m5cDsDQXg2PUIYPqHYcXyxbT2/pub?output=csv";
Auth.requireCoach();

function toggleMenu() {
  const m = document.getElementById("mobileMenu");
  m.style.display = (m.style.display === "flex") ? "none" : "flex";
}

function parseCSV(text) {
  const rows = [];
  let row = [];
  let cur = "";
  let inQuotes = false;

  for (let i = 0; i < text.length; i++) {
    const ch = text[i];
    const next = text[i + 1];
    if (ch === '"' && inQuotes && next === '"') { cur += '"'; i++; }
    else if (ch === '"') inQuotes = !inQuotes;
    else if (ch === "," && !inQuotes) { row.push(cur); cur = ""; }
    else if ((ch === "\n" || ch === "\r") && !inQuotes) {
      if (cur.length || row.length) row.push(cur);
      if (row.length) rows.push(row);
      row = []; cur = "";
      if (ch === "\r" && next === "\n") i++;
    } else cur += ch;
  }
  if (cur.length || row.length) { row.push(cur); rows.push(row); }
  return rows;
}

const nk = s => String(s||"").trim().toLowerCase().replace(/\s+/g,"");
const slugify = s => String(s||"").trim().toLowerCase().replace(/&/g,"and").replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"");

function normalizePhoto(v){
  v=String(v||"").trim();
  if(!v) return "images/placeholder.png";
  if(v.startsWith("http")) return v;
  if(v.startsWith("images/")||v.startsWith("./images/")) return v.replace("./","");
  return `images/${v}`;
}
function normalizeTwitter(v){
  v=String(v||"").trim();
  if(!v) return "";
  if(v.startsWith("http")) return v;
  v=v.replace(/^@/,"").trim();
  return v ? `https://twitter.com/${v}` : "";
}
function normalizeHudl(v){
  v=String(v||"").trim();
  if(!v) return "";
  return v.startsWith("http") ? v : "";
}
function pick(map,row,opts){
  for(const opt of opts){
    const k=nk(opt);
    if(map[k]!==undefined) return row[map[k]] ?? "";
  }
  return "";
}

async function run(){
  const id = new URLSearchParams(location.search).get("id") || "";
  const box = document.getElementById("profile");

  const res = await fetch(CSV_URL, {cache:"no-store"});
  const text = await res.text();
  const rows = parseCSV(text);
  const headers = rows[0] || [];
  const map = {};
  headers.forEach((h,i)=>map[nk(h)]=i);

  const data = rows.slice(1).map(r=>{
    const name = pick(map,r,["Name"]).trim();
    if(!name) return null;
    return {
      name,
      slug: slugify(name),
      classYear: pick(map,r,["Class"]).trim(),
      position: pick(map,r,["Position"]).trim(),
      heightWeight: pick(map,r,["HeightWeight"]).trim(),
      gpa: pick(map,r,["GPA"]).trim(),
      writeup: pick(map,r,["Writeup"]).trim(),
      hudl: normalizeHudl(pick(map,r,["HUDL","Hudl"])),
      twitter: normalizeTwitter(pick(map,r,["Twitter","X"])),
      photo: normalizePhoto(pick(map,r,["ImageURL","Photo"]))
    };
  }).filter(Boolean);

  const p = data.find(x=>x.slug===id);
  if(!p){
    box.innerHTML = `<div class="status">Profile not found. <a href="recruits.html">Back to recruits</a></div>`;
    return;
  }

  document.title = `${p.name} | Serra Recruiting`;

  box.innerHTML = `
    <div class="profile-top">
      <div class="profile-photo">
        <img src="${p.photo}" alt="${p.name}" onerror="this.src='images/placeholder.png'">
      </div>
      <div class="profile-info">
        <h1 class="profile-name">${p.name}</h1>
        <div class="muted">${p.position || ""}</div>
        <div class="muted">Class of ${p.classYear || ""}${p.gpa ? ` • GPA ${p.gpa}` : ""}</div>
        <div class="muted">${p.heightWeight || ""}</div>

        <div class="profile-links">
          ${p.twitter ? `<a class="btn small" href="${p.twitter}" target="_blank" rel="noopener">X / Twitter</a>` : ""}
          ${p.hudl ? `<a class="btn small" href="${p.hudl}" target="_blank" rel="noopener">Hudl Film</a>` : ""}
          <a class="btn small" href="recruits.html">Back to Recruits</a>
        </div>
      </div>
    </div>

    ${p.writeup ? `<div class="writeup"><h3>Scouting Write-up</h3><p>${escapeHtml(p.writeup)}</p></div>` : ""}
  `;
}

function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;").replaceAll('"',"&quot;")
    .replaceAll("'","&#039;").replace(/\n/g,"<br>");
}

run().catch(()=>{
  document.getElementById("profile").innerHTML = `<div class="status">Error loading profile.</div>`;
});
</script>
</body>
</html>